"""
Test sheet for irs_power.sage
"""

load('./interleaved_code.sage')
load('./irs_power.sage')
# load('./failure_prob.sage')
load('./util.sage')


# Code/Decoder Parameters
# F = GF(Primes().next(255),'a')
F = GF(521,'a')
# n,k= F.cardinality()-1, floor((F.cardinality()-1)/3)
n = 520
k = 128
base_code = codes.GeneralizedReedSolomonCode(F.list()[1:n+1], k)

h = 2
IC = IRSCode(base_code, h)

#
c = IC.random_element()
m = IC.unencode(c)
assert c == IC.encode(m)


###

## Optional: Compute good parameters
# print 'computing list of good parameters ...'
# ell_s_list, ell_s_list_minimal = irs_power_decoding_tau_ell_s_list(C,h)

s, ell = 3, 5
Dec = IRSPowerDecoder(IC, (s, ell))
tau_max = Dec.decoding_radius()
tau = tau_max-1 # It seems that there is some slight mistake in the derivation of the decoding radius since tau_max many errors are usually not correctable, but tau_max-1 many errors are

tau = tau_max

# Inform User About Parameters
print('\n###################################################')
print('Parameters:')
print('###################################################')
print('Interleaving degree        h =', h)
print('Power Parameter          ell =', ell)
print('Multiplicity Parameter     s =', s)
print('###################################################')
print('Decoding Radius        t_max =', tau_max)
print('Number of Errors         tau =', tau)
print('###################################################')
print('[SSB] Decoding Radius        =', floor(h/(h+1)*(n-k)))
print('###################################################\n')


### Encoding and Channel
Ch = SynchronizedBurstStaticRateChannel(IC.ambient_space(), tau, IC.order())
c = IC.random_element()
r = Ch.transmit(c)

print(Ch.burst_error_distance(r, c))

# share = [209, 394, 389, 194, 513, 419, 261, 336, 291, 164, 440, 405, 451, 100, 289, 332, 397, 439, 204, 411, 295, 476, 474, 491, 424, 69, 222, 186, 137, 344, 57, 186, 355, 18, 426, 435, 461, 222, 133, 110, 452, 431, 195, 254, 245, 306, 440, 372, 335, 515, 453, 490, 242, 399, 1, 294, 145, 238, 99, 80, 271, 445, 2, 482, 398, 43, 135, 392, 337, 432, 153, 518, 235, 159, 366, 483, 244, 349, 475, 270, 3, 239, 185, 481, 326, 202, 128, 512, 111, 357, 273, 116, 391, 115, 221, 376, 448, 443, 398, 21, 253, 373, 504, 233, 255, 317, 132, 187, 336, 139, 148, 513, 167, 329, 220, 62, 492, 250, 403, 56, 390, 489, 90, 185, 100, 462, 241, 308, 416, 515, 256, 265, 242, 423, 317, 57, 425, 171, 359, 414, 14, 207, 18, 6, 316, 126, 469, 150, 477, 73, 130, 374, 37, 232, 185, 387, 356, 418, 67, 267, 287, 370, 334, 302, 238, 91, 515, 403, 459, 394, 472, 288, 280, 168, 403, 390, 72, 149, 491, 142, 144, 66, 505, 62, 447, 270, 47, 213, 380, 384, 423, 433, 466, 483, 438, 390, 44, 451, 168, 470, 168, 79, 459, 452, 517, 53, 515, 141, 428, 414, 146, 418, 261, 136, 325, 514, 196, 345, 98, 474, 468, 268, 315, 163, 324, 262, 147, 204, 100, 169, 495, 414, 156, 377, 482, 45, 105, 239, 347, 107, 235, 482, 299, 60, 355, 455, 276, 266, 365, 14, 381, 337, 334, 402, 386, 344, 469, 375, 294, 17, 170, 40, 155, 216, 424, 2, 431, 29, 165, 179, 374, 135, 347, 346, 437, 466, 6, 497, 440, 309, 200, 226, 24, 416, 188, 67, 242, 227, 387, 374, 478, 185, 80, 367, 145, 263, 156, 52, 234, 196, 465, 434, 325, 154, 436, 310, 41, 13, 223, 166, 282, 142, 383, 393, 502, 334, 21, 83, 128, 35, 68, 184, 110, 163, 362, 353, 513, 382, 57, 474, 47, 492, 442, 415, 403, 282, 171, 94, 374, 470, 56, 476, 296, 321, 293, 416, 185, 249, 214, 177, 152, 383, 225, 397, 496, 273, 174, 112, 132, 120, 329, 445, 171, 317, 420, 498, 151, 458, 187, 103, 478, 40, 249, 432, 370, 407, 317, 306, 328, 90, 416, 501, 131, 489, 416, 396, 256, 396, 226, 30, 448, 366, 317, 35, 288, 264, 14, 297, 94, 116, 338, 435, 505, 106, 465, 131, 378, 144, 461, 272, 297, 506, 130, 139, 463, 472, 29, 355, 186, 418, 65, 80, 520, 305, 19, 251, 147, 165, 165, 467, 148, 450, 227, 472, 113, 55, 35, 384, 373, 13, 332, 328, 499, 425, 276, 374, 38, 338, 177, 234, 450, 328, 443, 203, 133, 195, 15, 56, 369, 384, 420, 181, 489, 329, 501, 305, 122, 209, 83, 323, 171, 315, 83, 310, 56, 480, 29, 129, 180, 82, 405, 300, 495, 517, 154, 117, 437, 509, 454, 410, 220, 150, 428, 30, 374, 424, 20, 42, 340, 159, 93, 104, 489, 422, 104, 403, 118, 30, 427, 504, 183, 74, 148, 432, 148, 351, 504, 6, 453, 103, 59, 137, 366, 9, 232, 255, 500, 300, 73, 5, 442, 364, 169, 9, 346, 241, 23, 13, 278, 388, 247, 422, 50, 139, 486, 397, 186, 502, 204, 223, 482, 323, 210, 70, 55, 156, 77, 389, 235, 116, 504, 370, 150, 490, 201, 459, 272, 447, 433, 119, 351, 10, 99, 73, 292, 442, 98, 140, 301, 413, 476, 428, 95, 288, 75, 44, 127, 408, 99, 78, 54, 247, 9, 148, 472, 176, 468, 112, 479, 117, 14, 428, 375, 321, 473, 460, 86, 436, 164, 114, 342, 216, 307, 117, 221, 28, 381, 404, 95, 372, 310, 286, 124, 405, 479, 290, 272, 493, 147, 294, 97, 355, 409, 161, 309, 412, 7, 209, 373, 464, 216, 248, 131, 62, 38, 467, 431, 399, 492, 243, 483, 196, 34, 32, 53, 119, 433, 357, 221, 32, 456, 55, 18, 438, 486, 101, 362, 46, 135, 13, 360, 49, 144, 372, 479, 496, 95, 266, 136, 349, 191, 376, 143, 389, 117, 81, 433, 386, 101, 404, 323, 88, 104, 249, 477, 370, 430, 402, 219, 102, 254, 393, 403, 482, 245, 16, 436, 109, 175, 405, 341, 281, 353, 20, 389, 371, 60, 62, 320, 234, 505, 367, 451, 8, 413, 108, 409, 323, 220, 294, 98, 439, 464, 77, 351, 86, 415, 92, 368, 29, 426, 318, 243, 405, 186, 241, 245, 129, 145, 146, 441, 514, 57, 146, 2, 182, 37, 75, 2, 206, 366, 282, 107, 486, 286, 285, 326, 448, 22, 358, 506, 280, 265, 399, 267, 139, 458, 75, 254, 206, 449, 43, 99, 327, 12, 209, 106, 293, 349, 143, 295, 100, 519, 127, 251, 55, 143, 472, 464, 378, 362, 390, 63, 54, 227, 225, 354, 321, 442, 339, 390, 139, 347, 481, 390, 341, 511, 394, 394, 150, 119, 108, 125, 59, 223, 337, 188, 174, 278, 126, 375, 472, 357, 225, 510, 496, 382, 503, 234, 117, 264, 322, 44, 253, 153, 505, 364, 476, 336, 347, 90, 448, 387, 183, 482, 45, 177, 416, 136, 67, 336, 223, 504, 0, 379, 41, 504, 453, 365, 152, 216, 446, 502, 199, 277, 67, 176, 43, 303, 353, 212, 469, 301, 210, 96, 156, 404, 282, 446, 271, 214, 400, 457, 120, 364, 406, 79, 108, 194, 6, 375, 18, 437, 52, 361, 501, 3, 220, 150, 498, 241, 127, 414, 452, 121, 304, 118, 257, 33, 214, 177, 54, 177, 129, 519, 455, 395, 211, 122, 258, 209, 197, 321, 177, 57, 82, 241, 517, 429, 315, 106, 304, 446, 355, 113, 285, 95, 355, 508, 104, 265, 297, 73, 206, 180, 256, 363, 316, 15, 370, 461, 322, 112, 77, 395, 307, 484, 255, 490, 269, 130, 188, 462, 62, 356, 171, 180, 127, 41, 203, 264, 497, 432, 19, 445, 247, 279, 195, 480, 515, 273, 472, 481, 419, 65, 511, 81, 372, 137, 114, 181, 356, 496, 431, 115, 99, 192, 455, 274, 358, 103, 102, 18, 201, 430, 133, 43, 201, 109, 474, 491, 52, 492, 441, 446, 449, 236, 122, 200, 132, 403, 113, 75, 262, 312, 510, 421, 183, 173, 308]
share =  [89, 346, 394, 31, 103, 65, 229, 431, 177, 149, 86, 360, 327, 107, 50, 446, 517, 393, 419, 450, 485, 259, 48, 411, 416, 342, 321, 299, 44, 277, 268, 446, 12, 387, 323, 278, 126, 99, 332, 507, 519, 358, 182, 54, 126, 455, 161, 104, 387, 64, 20, 37, 371, 484, 478, 26, 460, 402, 470, 361, 419, 37, 19, 200, 460, 319, 363, 6, 362, 275, 329, 395, 90, 14, 492, 15, 391, 164, 44, 437, 351, 516, 372, 398, 406, 122, 282, 115, 407, 508, 297, 30, 154, 520, 34, 215, 312, 483, 129, 96, 341, 33, 396, 147, 310, 143, 50, 472, 224, 54, 63, 379, 108, 38, 302, 516, 196, 444, 511, 102, 159, 86, 495, 14, 366, 199, 388, 443, 334, 203, 148, 462, 233, 333, 144, 464, 483, 401, 100, 215, 342, 416, 404, 331, 344, 487, 251, 210, 242, 255, 37, 195, 315, 343, 515, 360, 98, 280, 417, 411, 313, 362, 53, 216, 254, 508, 286, 329, 173, 59, 506, 11, 124, 407, 348, 491, 505, 346, 176, 121, 405, 128, 422, 26, 43, 520, 151, 16, 359, 422, 460, 60, 504, 454, 204, 217, 436, 148, 467, 337, 298, 232, 423, 27, 24, 138, 98, 105, 29, 217, 389, 149, 160, 146, 140, 344, 179, 131, 403, 98, 408, 376, 346, 97, 191, 160, 183, 385, 227, 413, 129, 36, 403, 518, 47, 142, 162, 216, 498, 449, 152, 119, 151, 206, 223, 121, 276, 204, 157, 150, 417, 344, 164, 61, 272, 507, 377, 272, 4, 341, 466, 504, 409, 485, 402, 358, 52, 20, 221, 409, 40, 309, 103, 388, 156, 160, 227, 518, 402, 495, 318, 436, 110, 253, 444, 137, 282, 250, 367, 411, 329, 249, 290, 35, 393, 360, 142, 398, 15, 368, 275, 178, 165, 340, 108, 171, 271, 93, 92, 496, 206, 308, 315, 173, 63, 458, 394, 227, 303, 350, 383, 396, 288, 301, 79, 139, 389, 121, 13, 390, 89, 33, 224, 56, 424, 390, 52, 498, 54, 377, 179, 112, 276, 145, 269, 42, 324, 279, 280, 67, 380, 459, 459, 248, 199, 267, 459, 269, 114, 403, 138, 306, 443, 30, 96, 195, 285, 424, 399, 302, 116, 399, 380, 23, 90, 44, 166, 466, 73, 465, 338, 369, 25, 471, 124, 449, 265, 383, 273, 278, 493, 419, 490, 267, 393, 81, 32, 56, 156, 317, 252, 68, 167, 329, 400, 477, 17, 279, 329, 124, 0, 360, 300, 476, 508, 494, 195, 226, 377, 86, 247, 153, 269, 391, 66, 177, 478, 5, 122, 107, 172, 352, 7, 247, 107, 180, 253, 247, 412, 277, 144, 109, 40, 217, 342, 333, 19, 420, 300, 114, 251, 170, 110, 160, 179, 333, 48, 118, 36, 11, 231, 321, 38, 509, 281, 168, 386, 438, 309, 410, 29, 145, 56, 424, 491, 438, 15, 259, 15, 415, 180, 510, 376, 509, 511, 87, 63, 255, 203, 97, 212, 221, 415, 55, 98, 120, 175, 375, 284, 400, 365, 470, 478, 172, 377, 70, 111, 393, 518, 411, 338, 311, 190, 198, 226, 250, 101, 327, 403, 491, 350, 20, 185, 63, 432, 258, 41, 115, 114, 84, 377, 259, 48, 161, 82, 8, 502, 27, 413, 197, 179, 129, 286, 487, 334, 317, 272, 143, 371, 228, 377, 225, 512, 294, 115, 367, 57, 1, 499, 263, 84, 310, 20, 433, 339, 62, 313, 459, 195, 419, 141, 30, 247, 48, 150, 68, 80, 491, 345, 193, 398, 239, 455, 286, 168, 110, 97, 267, 203, 513, 406, 433, 504, 26, 145, 513, 466, 352, 432, 257, 339, 432, 76, 246, 412, 61, 245, 173, 20, 155, 264, 124, 69, 162, 393, 162, 267, 32, 520, 237, 196, 488, 106, 306, 23, 404, 242, 405, 27, 210, 323, 298, 185, 472, 55, 279, 304, 475, 344, 490, 9, 34, 143, 396, 519, 290, 332, 271, 474, 242, 467, 147, 415, 11, 471, 420, 318, 459, 149, 180, 183, 271, 174, 293, 438, 355, 348, 16, 417, 189, 165, 444, 13, 277, 36, 207, 180, 385, 382, 45, 446, 206, 356, 142, 272, 225, 425, 340, 345, 509, 361, 87, 503, 517, 104, 340, 295, 327, 41, 336, 5, 265, 226, 443, 31, 120, 46, 214, 273, 295, 424, 318, 178, 321, 314, 239, 8, 126, 256, 39, 380, 186, 87, 500, 300, 471, 184, 443, 15, 60, 269, 147, 32, 467, 226, 155, 224, 444, 224, 366, 0, 19, 126, 220, 21, 155, 290, 33, 9, 312, 187, 262, 50, 57, 397, 196, 44, 326, 486, 30, 98, 364, 360, 392, 39, 464, 375, 381, 7, 323, 436, 317, 388, 53, 434, 117, 482, 173, 422, 76, 23, 382, 391, 132, 436, 191, 338, 22, 179, 325, 320, 269, 148, 305, 258, 375, 86, 147, 231, 286, 244, 381, 208, 452, 221, 178, 501, 306, 223, 472, 53, 238, 121, 401, 339, 338, 88, 143, 362, 19, 212, 398, 121, 125, 147, 241, 125, 9, 451, 258, 318, 278, 271, 180, 307, 205, 294, 295, 90, 456, 460, 240, 95, 301, 32, 501, 355, 475, 245, 227, 276, 84, 34, 368, 124, 183, 262, 358, 118, 187, 142, 237, 159, 439, 183, 472, 91, 118, 180, 298, 89, 202, 69, 26, 370, 28, 426, 240, 121, 167, 175, 238, 486, 50, 158, 502, 145, 516, 479, 227, 402, 27, 268, 157, 10, 362, 88, 512, 70, 180, 71, 374, 106, 92, 186, 45, 43, 303, 385, 189, 303, 173, 350, 320, 454, 386, 59, 475, 254, 164, 90, 172, 458, 76, 482, 453, 410, 226, 499, 236, 314, 43, 267, 258, 342, 238, 311, 183, 114, 379, 326, 361, 418, 132, 157, 106, 520, 146, 344, 454, 266, 496, 513, 235, 62, 190, 323, 346, 283, 394, 361, 24, 25, 354, 311, 94, 392, 123, 127, 52, 384, 193, 260, 255, 12, 200, 84, 148, 48, 424, 326, 80, 307, 10, 89, 44, 483, 39, 13, 508, 387, 82, 302, 199, 297, 416, 352, 503, 236, 430, 497, 276, 429, 259, 45, 387, 410, 433, 310, 146, 253, 206, 459, 306, 379, 177, 471, 338, 237, 206, 120, 323, 391, 287, 218, 141, 279, 484, 508, 337, 406, 473, 149, 83, 6, 240, 139, 143, 405, 348]
r2 = vector(F, share)
print("Test")
m = Dec.decode_to_message(r2)
print(m)
c2 = IC.encode(m)
print(Ch.burst_error_distance(r2, c2))

### A single decoding
print("Running a single decoding:")
m = Dec.decode_to_message(r)
if m == IC.unencode(c):
    print("Decoding succeeded")
else:
    print("Decoding failed!")


### A longer decoding test
print("Running a longer decoding test:")
report = test_decoder(IC, Dec, Ch, N=100, progress=True)


### For debugging: Explicitly compare the error locator
print('\n###################################################')

v = Dec._short_vector(Dec._build_module(r))

errs = Ch.burst_non_zero_positions(r - c)
alphas = IC.evaluation_points()
x = Dec._Px.gen()
Lambda = prod(x - alphas[i] for i in errs)

if v[0].monic()==Lambda^s:
    print('Decoding successful!')
else:
    print('Decoding failed!')
print('###################################################\n')
